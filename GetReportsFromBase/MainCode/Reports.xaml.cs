using GetReportsFromBase.Class;
using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using Microsoft.WindowsAPICodePack.Dialogs;
using System.IO;

namespace GetReportsFromBase
{
    /// <summary>
    /// Interaction logic for Reports.xaml
    /// </summary>
    public partial class Reports : Window
    {
        private SqlConnect _sqlConnect;
        private ReportsCollection _ReportsCollection;
        public Reports(SqlConnect conn)
        {
            InitializeComponent();
            _sqlConnect = conn;
            string sqlQuery = "DECLARE @raporty varchar(max) =\r\n'\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tNalepki\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT z danymi technicznymi\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT wg grup GUS\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT z danymi technicz. + opis\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tŚrodki nieumorzone podatkowo\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT z danymi technicz. + opis + szpital\t&\r\nEwidencja MT   \t|\tMT wg numeru inwentarzowego             \t|\tŚrodki o różnym statusie \t&\r\nfk_dekr_kk     \t|\tKartoteka kont                          \t|\tKARTOTEKA w PLN.\t&\r\nfk_dekr_kk     \t|\tNota Księgowa                           \t|\tPolecenie ksiegowania\t&\r\nfk_dekr_kk     \t|\tNota Księgowa Pełna                     \t|\tPolecenie ksiegowania - pelne\t&\r\nfk_dekr_kk     \t|\tDekret                                  \t|\tDEKRET PODSTAWOWY\t&\r\nfk_dekr_kk     \t|\tDekret                                  \t|\tPOLECENIE KSIĘGOWANIA - DEKRET PODSTAW.\t&\r\nfk_dekr_kk     \t|\tKartoteka kont wielowalutowa            \t|\tKartoteka Wielowalutowa\t&\r\nmtf_opr_k      \t|\tWydruk operacji likwidacji częściowej.  \t|\tLikwidacja częściowa\t&\r\nmtf_opr_k      \t|\tWydruk operacji likwidacji częściowej.  \t|\tLikwidacja częściowa z ilością\t&\r\nmtf_opr_k      \t|\tWydruk operacji likwidacji częściowej.  \t|\tLikwidacja cz. z ilością - bez kom.\t&\r\nmtf_opr_l      \t|\tWydruk operacji likwidacji.             \t|\tLikwidacja\t&\r\nmtf_opr_l      \t|\tWydruk operacji likwidacji.             \t|\tLikwidacja PAM - bez komisji\t&\r\nmtf_opr_m      \t|\tWydruk operacji zmiany miejsca          \t|\tŚrodki trwałe - zmiana miejsca z podpis.\t&\r\nmtf_opr_m      \t|\tWydruk operacji zmiany miejsca          \t|\tŚrodki trwałe - zmiana miejsca z podpis.+ ilość\t&\r\nmtf_opr_m      \t|\tLista operacji MT                       \t|\tLista operacji na wartosciach\t&\r\nmtf_opr_ot     \t|\tLista operacji MT                       \t|\tLista operacji na wartościach\t&\r\nNaleznosci     \t|\tNależności                              \t|\tNierozliczone nalezności wg kont\t&\r\nNaleznosci     \t|\tNależności                              \t|\tStruktura wiekowa nal. - z plat.i zob.\t&\r\nNotyOdsetk     \t|\tNota odsetkowa                          \t|\tNOTA ODSETKOWA (zbiorczo)\t&\r\nObroty         \t|\tZestawienie obrotów i sald              \t|\tOBROTÓWKA - Ograniczone prawa\t&\r\nObroty         \t|\tKartoteka kont                          \t|\tKARTOTEKA - ograniczone prawa\t&\r\nRep            \t|\tRepozytorium systemu - wartości klas    \t|\tRepozytorium\t&\r\nRep            \t|\tRepozytorium systemu - wartości klas    \t|\tJEDNOSTKI\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tNOTA ODSETKOWA\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM + KOMUNIKAT\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM 2\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM 3\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM+KOMUNIKAT 2\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM+KOMUNIKAT 3\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozl. z kontrah.zbiorcze wg kont-nieprz.\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozl.z kontrah.zbiorcze wg kont 2\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie z kontrah.zbiorcze wg kont\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie z kontrahentem zbiorcze\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie zbiorcze\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie zbiorcze wg kont\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tWEZWANIE DO ZAPŁATY PEŁNE\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tWEZWANIE DO ZAPŁATY POJEDYNCZE\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tWEZWANIE DO ZAPŁATY ZBIORCZE\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tZestawienie sald wg kont\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tZestawienie sald wg stron rozrach.\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń należności z dekretami\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń zobowiązań z dekretami\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń płatności obcych z dekretami\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń płatności własnych z dekretami\t&\r\nZapisyNaKontach\t|\tZapisy na kontach                       \t|\tZapisy na kontach z pods.kont i podokr.\t&\r\nZapisyNaKontach\t|\tZapisy na kontach                       \t|\tZapisy na kontach z podsumowaniem_\t&\r\n'\r\n\r\nDECLARE @End varchar(max)\r\nDECLARE @Row int\r\nDECLARE @Table table \r\n(\r\n\tkontekst varchar(max), nazwa_rodzaju varchar(max), nazwa_raportu varchar(max)\r\n)\r\nDECLARE @Table2 table \r\n(\r\n\tid int,\r\n\tkontekst varchar(max), nazwa_rodzaju varchar(max), nazwa_raportu varchar(max),\r\n\tszl_idpb varchar(max), szl_syntax varchar(max), sp_name varchar(max)\r\n)\r\nSET @raporty = Trim(Replace(@raporty,CHAR(13) + CHAR(10),''))\r\nSET @Row = 1\r\nSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',1)))\r\nWHILE NOT IsNull(Trim(@End),'') = ''\r\n\tBEGIN\r\n\t\tINSERT INTO @Table(kontekst, nazwa_rodzaju, nazwa_raportu)\r\n\t\tSELECT\r\n\t\t\ttrim(replace(replace(replace((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',1)),char(9),' '),char(10),' '),char(13),' ')),\r\n\t\t\ttrim(replace(replace(replace((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',2)),char(9),' '),char(10),' '),char(13),' ')),\r\n\t\t\ttrim(replace(replace(replace((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',3)),char(9),' '),char(10),' '),char(13),' '))\r\n\r\n\t\tSET @Row = 1 + @Row\r\n\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',1)))\r\n\tEND\r\nINSERT INTO @Table2\r\nSELECT \r\n\tROW_NUMBER() OVER(ORDER BY kontekst, nazwa_rodzaju, nazwa_raportu, rss.szl_idpb), t.*, rss.szl_idpb, rss.szl_syntax, NULL--, Cast(('<srd>' + Cast(rss.szl_syntax as varchar(max)) + '</srd>') as xml)\r\nFROM \r\n\t@Table t\r\n\tLEFT JOIN rap_ctx rc on rc.ctx_idn = t.kontekst\r\n\tLEFT JOIN rap_rpt rr on rr.ctx_id = rc.ctx_id AND rr.rpt_nazwa = t.nazwa_rodzaju\r\n\tLEFT JOIN rap_szl rs on rs.rpt_id = rr.rpt_id AND rs.szl_nazwa = t.nazwa_raportu\r\n\tLEFT JOIN rap_szl_syntax rss on rss.szl_id = rs.szl_id\r\nWHERE \r\n\tIsNull(rs.szl_id,0) > 0\r\nORDER BY kontekst, nazwa_rodzaju, nazwa_raportu, szl_idpb\r\n\r\nDECLARE\r\n\t@id int,\r\n\t@szl_syntax varchar(max),\r\n\t@sp_name varchar(max)\r\nDECLARE CUR_REPORTS CURSOR LOCAL STATIC READ_ONLY FOR \r\n\tSELECT \r\n\t\tid, szl_syntax \r\n\tFROM \r\n\t\t@Table2 \r\n\torder by kontekst, nazwa_rodzaju, nazwa_raportu, szl_idpb\r\nOPEN CUR_REPORTS\r\nFETCH NEXT FROM CUR_REPORTS INTO @id, @szl_syntax\r\nWHILE (@@fetch_status = 0)\r\n\tBEGIN\r\n\t\tSET @Row = 1\r\n\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter(@szl_syntax,'.',@Row)))\r\n\t\tWHILE NOT IsNull(Trim(@End),'') = ''\r\n\t\t\tBEGIN\r\n\t\t\t\tIF IsNull(Trim(@End),'') like '%execute dbo'\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter(@szl_syntax,'.',@Row + 1)))\r\n\t\t\t\t\t\tSET @sp_name = Trim((SELECT dbo.uf_tkawulok_Splitter(@End,';',1)))\r\n\t\t\t\t\t\tSET @sp_name = Trim((SELECT dbo.uf_tkawulok_Splitter(@sp_name,'@',1)))\r\n\t\t\t\t\t\tSET @End = ''\r\n\t\t\t\t\t\tUPDATE @Table2 SET sp_name = IsNull('sp_helptext ' + @sp_name,NULL) WHERE id = @id\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @Row = 1 + @Row\r\n\t\t\t\t\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter(@szl_syntax,'.',@Row)))\r\n\t\t\t\t\tEND\r\n\t\t\tEND\r\n\t\tFETCH NEXT FROM CUR_REPORTS INTO @id, @szl_syntax\r\n\tEND\r\nCLOSE CUR_REPORTS\r\nDEALLOCATE CUR_REPORTS\r\n\r\nSELECT * FROM @Table2";
                //"DECLARE @raporty varchar(max) =\r\n'\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tNalepki\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT z danymi technicznymi\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT wg grup GUS\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT z danymi technicz. + opis\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tŚrodki nieumorzone podatkowo\t&\r\nEwidencja MT   \t|\tZestawienie wartościowe MT              \t|\tZestawienie MT z danymi technicz. + opis + szpital\t&\r\nEwidencja MT   \t|\tMT wg numeru inwentarzowego             \t|\tŚrodki o różnym statusie \t&\r\nfk_dekr_kk     \t|\tKartoteka kont                          \t|\tKARTOTEKA w PLN.\t&\r\nfk_dekr_kk     \t|\tNota Księgowa                           \t|\tPolecenie ksiegowania\t&\r\nfk_dekr_kk     \t|\tNota Księgowa Pełna                     \t|\tPolecenie ksiegowania - pelne\t&\r\nfk_dekr_kk     \t|\tDekret                                  \t|\tDEKRET PODSTAWOWY\t&\r\nfk_dekr_kk     \t|\tDekret                                  \t|\tPOLECENIE KSIĘGOWANIA - DEKRET PODSTAW.\t&\r\nfk_dekr_kk     \t|\tKartoteka kont wielowalutowa            \t|\tKartoteka Wielowalutowa\t&\r\nmtf_opr_k      \t|\tWydruk operacji likwidacji częściowej.  \t|\tLikwidacja częściowa\t&\r\nmtf_opr_k      \t|\tWydruk operacji likwidacji częściowej.  \t|\tLikwidacja częściowa z ilością\t&\r\nmtf_opr_k      \t|\tWydruk operacji likwidacji częściowej.  \t|\tLikwidacja cz. z ilością - bez kom.\t&\r\nmtf_opr_l      \t|\tWydruk operacji likwidacji.             \t|\tLikwidacja\t&\r\nmtf_opr_l      \t|\tWydruk operacji likwidacji.             \t|\tLikwidacja PAM - bez komisji\t&\r\nmtf_opr_m      \t|\tWydruk operacji zmiany miejsca          \t|\tŚrodki trwałe - zmiana miejsca z podpis.\t&\r\nmtf_opr_m      \t|\tWydruk operacji zmiany miejsca          \t|\tŚrodki trwałe - zmiana miejsca z podpis.+ ilość\t&\r\nmtf_opr_m      \t|\tLista operacji MT                       \t|\tLista operacji na wartosciach\t&\r\nmtf_opr_ot     \t|\tLista operacji MT                       \t|\tLista operacji na wartościach\t&\r\nNaleznosci     \t|\tNależności                              \t|\tNierozliczone nalezności wg kont\t&\r\nNaleznosci     \t|\tNależności                              \t|\tStruktura wiekowa nal. - z plat.i zob.\t&\r\nNotyOdsetk     \t|\tNota odsetkowa                          \t|\tNOTA ODSETKOWA (zbiorczo)\t&\r\nObroty         \t|\tZestawienie obrotów i sald              \t|\tOBROTÓWKA - Ograniczone prawa\t&\r\nObroty         \t|\tKartoteka kont                          \t|\tKARTOTEKA - ograniczone prawa\t&\r\nRep            \t|\tRepozytorium systemu - wartości klas    \t|\tRepozytorium\t&\r\nRep            \t|\tRepozytorium systemu - wartości klas    \t|\tJEDNOSTKI\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tNOTA ODSETKOWA\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM + KOMUNIKAT\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM 2\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM 3\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM+KOMUNIKAT 2\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tPOTWIERDZENIE SALD Z OPISEM+KOMUNIKAT 3\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozl. z kontrah.zbiorcze wg kont-nieprz.\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozl.z kontrah.zbiorcze wg kont 2\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie z kontrah.zbiorcze wg kont\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie z kontrahentem zbiorcze\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie zbiorcze\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tRozliczenie zbiorcze wg kont\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tWEZWANIE DO ZAPŁATY PEŁNE\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tWEZWANIE DO ZAPŁATY POJEDYNCZE\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tWEZWANIE DO ZAPŁATY ZBIORCZE\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tZestawienie sald wg kont\t&\r\nRozlKontr      \t|\tRozliczenia z kontrahentami             \t|\tZestawienie sald wg stron rozrach.\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń należności z dekretami\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń zobowiązań z dekretami\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń płatności obcych z dekretami\t&\r\nRozrachunki    \t|\tRozrachunki                             \t|\tHistoria rozliczeń płatności własnych z dekretami\t&\r\nZapisyNaKontach\t|\tZapisy na kontach                       \t|\tZapisy na kontach z pods.kont i podokr.\t&\r\nZapisyNaKontach\t|\tZapisy na kontach                       \t|\tZapisy na kontach z podsumowaniem_\t&\r\n'\r\n\r\nDECLARE @End varchar(max)\r\nDECLARE @Row int\r\nDECLARE @Table table \r\n(\r\n\tkontekst varchar(max), nazwa_rodzaju varchar(max), nazwa_raportu varchar(max)\r\n)\r\nDECLARE @Table2 table \r\n(\r\n\tid int,\r\n\tkontekst varchar(max), nazwa_rodzaju varchar(max), nazwa_raportu varchar(max),\r\n\tszl_idpb varchar(max), szl_syntax varchar(max), sp_name varchar(max)\r\n)\r\nSET @raporty = Trim(Replace(@raporty,CHAR(13) + CHAR(10),''))\r\nSET @Row = 1\r\nSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',1)))\r\nWHILE NOT IsNull(Trim(@End),'') = ''\r\n\tBEGIN\r\n\t\tINSERT INTO @Table(kontekst, nazwa_rodzaju, nazwa_raportu)\r\n\t\tSELECT\r\n\t\t\ttrim(replace(replace(replace((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',1)),char(9),' '),char(10),' '),char(13),' ')),\r\n\t\t\ttrim(replace(replace(replace((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',2)),char(9),' '),char(10),' '),char(13),' ')),\r\n\t\t\ttrim(replace(replace(replace((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',3)),char(9),' '),char(10),' '),char(13),' '))\r\n\r\n\t\tSET @Row = 1 + @Row\r\n\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter((SELECT dbo.uf_tkawulok_Splitter(@raporty,'&',@Row)),'|',1)))\r\n\tEND\r\nINSERT INTO @Table2\r\nSELECT \r\n\tROW_NUMBER() OVER(ORDER BY kontekst, nazwa_rodzaju, nazwa_raportu, rss.szl_idpb), t.*, rss.szl_idpb, rss.szl_syntax, NULL--, Cast(('<srd>' + Cast(rss.szl_syntax as varchar(max)) + '</srd>') as xml)\r\nFROM \r\n\t@Table t\r\n\tLEFT JOIN rap_ctx rc on rc.ctx_idn = t.kontekst\r\n\tLEFT JOIN rap_rpt rr on rr.ctx_id = rc.ctx_id AND rr.rpt_nazwa = t.nazwa_rodzaju\r\n\tLEFT JOIN rap_szl rs on rs.rpt_id = rr.rpt_id AND rs.szl_nazwa = t.nazwa_raportu\r\n\tLEFT JOIN rap_szl_syntax rss on rss.szl_id = rs.szl_id\r\nWHERE \r\n\tIsNull(rs.szl_id,0) > 0\r\nORDER BY kontekst, nazwa_rodzaju, nazwa_raportu, szl_idpb\r\n\r\nDECLARE\r\n\t@id int,\r\n\t@szl_syntax varchar(max),\r\n\t@sp_name varchar(max)\r\nDECLARE CUR_REPORTS CURSOR LOCAL STATIC READ_ONLY FOR \r\n\tSELECT \r\n\t\tid, szl_syntax \r\n\tFROM \r\n\t\t@Table2 \r\n\torder by kontekst, nazwa_rodzaju, nazwa_raportu, szl_idpb\r\nOPEN CUR_REPORTS\r\nFETCH NEXT FROM CUR_REPORTS INTO @id, @szl_syntax\r\nWHILE (@@fetch_status = 0)\r\n\tBEGIN\r\n\t\tSET @Row = 1\r\n\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter(@szl_syntax,'.',@Row)))\r\n\t\tWHILE NOT IsNull(Trim(@End),'') = ''\r\n\t\t\tBEGIN\r\n\t\t\t\tIF IsNull(Trim(@End),'') like '%execute dbo'\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter(@szl_syntax,'.',@Row + 1)))\r\n\t\t\t\t\t\tSET @sp_name = Trim((SELECT dbo.uf_tkawulok_Splitter(@End,';',1)))\r\n\t\t\t\t\t\tSET @End = ''\r\n\t\t\t\t\t\tUPDATE @Table2 SET sp_name = IsNull('sp_helptext ' + @sp_name,NULL) WHERE id = @id\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @Row = 1 + @Row\r\n\t\t\t\t\t\tSET @End = Trim((SELECT dbo.uf_tkawulok_Splitter(@szl_syntax,'.',@Row)))\r\n\t\t\t\t\tEND\r\n\t\t\tEND\r\n\t\tFETCH NEXT FROM CUR_REPORTS INTO @id, @szl_syntax\r\n\tEND\r\nCLOSE CUR_REPORTS\r\nDEALLOCATE CUR_REPORTS\r\n\r\nSELECT * FROM @Table2";
                /*
                 "SELECT DISTINCT\r\n\trr.ctx_id, rs.rpt_id, rs.szl_id, rr.rpt_nazwa, rs.szl_nazwa\r\nFROM \r\n\trap_ctx rc \r\n\tINNER JOIN rap_rpt rr on rr.ctx_id = rc.ctx_id\r\n\tINNER JOIN rap_szl rs on rs.rpt_id = rr.rpt_id\r\n\tINNER JOIN rap_szl_syntax rss on rss.szl_id = rs.szl_id\r\nORDER BY rr.rpt_nazwa, rs.szl_nazwa";
            */
            DataTable table = _sqlConnect.GetTable(sqlQuery);
            _ReportsCollection = new ReportsCollection(table);
            //foreach(Report rep in ReportsCollection _ReportsCollection)

            DataContext = _ReportsCollection;

            var stringBuilder = new StringBuilder();
            foreach (Report report in _ReportsCollection.ReportsCol)
            {
                sqlQuery = report.sp;
                if(sqlQuery.Length > 0)
                {
                    table = new DataTable();
                    table = _sqlConnect.GetTable(sqlQuery);
                    stringBuilder = new StringBuilder();
                    foreach (DataRow row in table.Rows)
                    {
                        stringBuilder.Append(row[0].ToString());
                        //stringBuilder.Append(Environment.NewLine);
                    }
                    report.sp = stringBuilder.ToString();
                }
            }
            CommonOpenFileDialog dialog = new CommonOpenFileDialog();
            //dialog.InitialDirectory = "C:\\Users";
            dialog.IsFolderPicker = true;
            dialog.Multiselect = false;
            dialog.DefaultDirectory = "C:\\SIMPLE_SA";
            string path = "";
            if (dialog.ShowDialog() == CommonFileDialogResult.Ok)
            {
                path = dialog.FileName;
            }
            string newpath;
            foreach (Report report in _ReportsCollection.ReportsCol)
            {
                newpath = path + "\\" + report.rpt_nazwa + "\\" + report.szl_nazwa;
                System.IO.Directory.CreateDirectory(newpath);
                newpath += "\\" + report.szl_idpb;
                File.WriteAllText(newpath + ".srd", report.szl_syntax, Encoding.UTF8);
                if (report.sp.Length > 0)
                {
                    File.WriteAllText(newpath + ".sql", report.sp, Encoding.UTF8);
                }
            }
        }
    }
}
